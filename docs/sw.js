const APP_CACHE="ustory-static-v1",RUNTIME_CACHE="ustory-runtime-v1",IS_DEV="localhost"===self.location.hostname||"127.0.0.1"===self.location.hostname,STORY_API_HOST="story-api.dicoding.dev",STORY_API_PREFIX="/v1/stories";async function networkFirst(t){try{const a=await fetch(t);return(await caches.open(RUNTIME_CACHE)).put(t,a.clone()),a}catch{return await caches.match(t)||new Response(JSON.stringify({offline:!0}),{headers:{"Content-Type":"application/json"},status:200})}}async function cacheFirst(t){const a=await caches.open(RUNTIME_CACHE),e=await a.match(t);if(e)return e;try{const e=await fetch(t);return a.put(t,e.clone()),e}catch{return await caches.match("/images/logo.png")||new Response("",{status:504})}}self.addEventListener("install",(t=>{t.waitUntil((async()=>{const t=await caches.open(APP_CACHE),a=["/","/index.html","/images/logo.png","/images/favicon.png","/manifest.json"];for(const e of a)try{const a=new Request(e,{cache:"reload"}),n=await fetch(a);n.ok&&await t.put(a,n)}catch(t){console.warn("[SW] Precache skip:",e,t.message)}IS_DEV||await self.skipWaiting()})())})),self.addEventListener("activate",(t=>{t.waitUntil((async()=>{const t=await caches.keys();await Promise.all(t.filter((t=>![APP_CACHE,RUNTIME_CACHE].includes(t))).map((t=>caches.delete(t)))),IS_DEV||await self.clients.claim(),console.log("[SW] Active & ready âœ…")})())})),self.addEventListener("fetch",(t=>{const a=t.request,e=new URL(a.url);"GET"===a.method&&(IS_DEV&&(e.pathname.includes("hot-update")||e.pathname.includes("sockjs")||e.pathname.startsWith("/__webpack")||e.pathname.startsWith("/webpack")||e.pathname.startsWith("/hmr")||"/ws"===e.pathname||(a.headers.get("accept")||"").includes("text/event-stream"))||"/sw.js"!==e.pathname&&("image"!==a.destination||e.hostname!==STORY_API_HOST?e.hostname===STORY_API_HOST&&e.pathname.startsWith("/v1/stories")?t.respondWith(networkFirst(a)):"navigate"!==a.mode?e.origin===self.location.origin&&t.respondWith((async()=>{const t=await caches.open(RUNTIME_CACHE),e=await t.match(a);if(e)return e;try{const e=await fetch(a);return t.put(a,e.clone()),e}catch{return e||new Response("",{status:504})}})()):t.respondWith((async()=>{try{return await fetch(a)}catch{return await caches.match("/index.html")||new Response("<h1>Offline</h1>",{headers:{"Content-Type":"text/html"},status:200})}})()):t.respondWith(cacheFirst(a))))})),self.addEventListener("push",(t=>{let a={title:"UStory",options:{body:"Notifikasi baru"}};try{t.data&&(a=t.data.json())}catch(t){console.warn("[SW] Push payload parse fail:",t)}const e=a.options||{},n=e.actions||[{action:"open",title:"Lihat Detail"}],s=Object.assign({},e.data||{},{url:e.data&&e.data.url||"/"}),i=Object.assign({},e,{actions:n,data:s});t.waitUntil(self.registration.showNotification(a.title||"UStory",i))})),self.addEventListener("notificationclick",(t=>{const a=t.notification?.data?.url||"/";t.notification.close(),t.waitUntil((async()=>{const t=await clients.matchAll({type:"window",includeUncontrolled:!0}),e=new URL(a,self.location.origin).href,n=t.find((t=>t.url===e));if(n)return n.focus(),void n.postMessage({type:"PUSH_CLICK",url:a});const s=await clients.openWindow(e);try{s?.postMessage({type:"PUSH_CLICK",url:a})}catch{}})())}));